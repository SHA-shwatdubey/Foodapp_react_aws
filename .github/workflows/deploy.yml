name: Deploy to AWS with Terraform & Ansible

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  TF_VERSION: 1.5.0

jobs:
  build:
    name: Build React App
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'food-app/package-lock.json'

      - name: Install dependencies
        run: cd food-app && npm ci
        env:
          CI: true

      - name: Build application
        run: cd food-app && npm run build
        env:
          CI: true

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build
          path: food-app/build/
          retention-days: 1

  terraform:
    name: Terraform Plan & Apply
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: cd terraform && terraform init
        env:
          AWS_REGION: ${{ env.AWS_REGION }}

      - name: Terraform Plan
        run: cd terraform && terraform plan -out=tfplan
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
          TF_VAR_key_pair_name: ${{ secrets.AWS_KEY_PAIR_NAME }}

      - name: Terraform Apply
        run: cd terraform && terraform apply -auto-approve tfplan
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
          TF_VAR_key_pair_name: ${{ secrets.AWS_KEY_PAIR_NAME }}

      - name: Get Instance IP
        id: terraform_output
        run: |
          cd terraform
          INSTANCE_IP=$(terraform output -raw instance_public_ip)
          echo "instance_ip=$INSTANCE_IP" >> $GITHUB_OUTPUT
          echo "INSTANCE_IP=$INSTANCE_IP" >> $GITHUB_ENV

      - name: Upload Terraform state
        uses: actions/upload-artifact@v4
        with:
          name: terraform-state
          path: terraform/
          retention-days: 1

    outputs:
      instance_ip: ${{ steps.terraform_output.outputs.instance_ip }}

  ansible:
    name: Deploy with Ansible
    runs-on: ubuntu-latest
    needs: terraform

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: food-app/build/

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible boto3

      - name: Configure AWS credentials for SSH
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AWS_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ needs.terraform.outputs.instance_ip }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Wait for EC2 instance to be ready
        run: |
          INSTANCE_IP=${{ needs.terraform.outputs.instance_ip }}
          echo "Waiting for EC2 instance to be fully initialized..."
          for i in {1..60}; do
            if ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -o ConnectTimeout=5 ubuntu@$INSTANCE_IP "which npm" 2>/dev/null; then
              echo "âœ… NPM is available on instance"
              break
            fi
            echo "Attempt $i/60: Waiting for npm... ($(($i * 5)) seconds)"
            sleep 5
          done

      - name: Update Ansible inventory
        run: |
          cat > ansible/hosts << EOF
          [webservers]
          ${{ needs.terraform.outputs.instance_ip }} ansible_user=ubuntu ansible_private_key_file=~/.ssh/id_rsa

          [webservers:vars]
          ansible_python_interpreter=/usr/bin/python3
          EOF

      - name: Run Ansible playbook
        run: |
          cd ansible
          ansible-playbook -i hosts playbook.yml \
            -e "github_repo_url=${{ github.server_url }}/${{ github.repository }}.git" \
            -e "github_branch=${{ github.ref_name }}" \
            -v

      - name: Verify deployment
        run: |
          sleep 10
          curl -f http://${{ needs.terraform.outputs.instance_ip }} || echo "Deployment verification pending..."

  notify:
    name: Deployment Notification
    runs-on: ubuntu-latest
    needs: [terraform, ansible]
    if: always()

    steps:
      - name: Deployment Status
        run: |
          if [ "${{ needs.terraform.result }}" == "success" ] && [ "${{ needs.ansible.result }}" == "success" ]; then
            echo "âœ… Deployment successful!"
            echo "ðŸŒ Application URL: http://${{ needs.terraform.outputs.instance_ip }}"
          else
            echo "âŒ Deployment failed!"
            exit 1
          fi
